name: Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      project_data:
        description: 'Project data JSON (from your app)'
        required: false
        type: string
        default: '{}'
      app_name:
        description: 'App name for the build'
        required: true
        type: string
        default: 'NoCodeApp'
      bundle_id:
        description: 'Bundle ID (used if project_data not provided)'
        required: false
        type: string
        default: 'com.visios.nocode'
      version:
        description: 'App Version (used if project_data not provided)'
        required: false
        type: string
        default: '1.0.0'
      build_number:
        description: 'Build Number (used if project_data not provided)'
        required: false
        type: string
        default: '1'
      backend_url:
        description: 'Backend URL for app generation (or use BACKEND_URL secret)'
        required: false
        type: string
        default: ''

jobs:
  deploy-testflight:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Create Flutter project structure
      run: |
        echo "üèóÔ∏è Creating Flutter project structure..."
        
        # Parse project data to extract app info
        echo "üìä Parsing project configuration..."
        PROJECT_DATA='${{ github.event.inputs.project_data }}'
        APP_NAME='${{ github.event.inputs.app_name }}'
        
        # Check if we have meaningful project_data (not just empty {})
        if [ "$PROJECT_DATA" != "{}" ] && [ "$PROJECT_DATA" != "" ]; then
          echo "üì± Using project_data for app configuration"
          # Extract deployment info from project data
          BUNDLE_ID=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.bundleId // "${{ github.event.inputs.bundle_id }}"')
          VERSION=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.version // "${{ github.event.inputs.version }}"')
          BUILD_NUMBER=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.buildNumber // "'$(date +%s)'"')
          USE_PROJECT_DATA=true
        else
          echo "üì± Using manual inputs for app configuration"
          # Use manual inputs
          BUNDLE_ID='${{ github.event.inputs.bundle_id }}'
          VERSION='${{ github.event.inputs.version }}'
          BUILD_NUMBER='${{ github.event.inputs.build_number }}'
          USE_PROJECT_DATA=false
          # Create minimal project data for backend call
          PROJECT_DATA='{"templateId":"default","projectId":"github-action-build","template":{},"deploymentInfo":{"appName":"'$APP_NAME'","bundleId":"'$BUNDLE_ID'","version":"'$VERSION'","buildNumber":"'$BUILD_NUMBER'"}}'
        fi
        
        echo "üì± Final App Configuration:"
        echo "   Name: $APP_NAME"
        echo "   Bundle ID: $BUNDLE_ID"
        echo "   Version: $VERSION"
        echo "   Build Number: $BUILD_NUMBER"
        echo "   Using Project Data: $USE_PROJECT_DATA"
        
        # Store in environment for later steps
        echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
        echo "PROJECT_DATA=$PROJECT_DATA" >> $GITHUB_ENV
        
        mkdir -p flutter_project
        cd flutter_project
        
        # Initialize Flutter project
        flutter create . --org=$BUNDLE_ID --project-name=app
        
        # Create the app using our backend service
        echo "üì± Generating app from backend..."
        
        # Use BACKEND_URL secret if available, otherwise use input
        BACKEND_URL='${{ secrets.BACKEND_URL }}'
        if [ -z "$BACKEND_URL" ]; then
          BACKEND_URL='${{ github.event.inputs.backend_url }}'
        fi
        
        if [ -z "$BACKEND_URL" ]; then
          echo "‚ùå No backend URL provided! Please set BACKEND_URL secret or provide backend_url input"
          exit 1
        fi
        
        echo "üåê Using backend URL: $BACKEND_URL"
        curl -X POST "$BACKEND_URL/api/package-flutter" \
          -H "Content-Type: application/json" \
          -d "$PROJECT_DATA" \
          --output app_package.zip
          
        # Extract the generated app
        echo "üì¶ Extracting generated Flutter app..."
        unzip -o app_package.zip
        
        # Create exportOptions.plist for later use
        echo "üìù Creating exportOptions.plist..."
        cat > ios/exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.visios.nocode</key>
                <string>noCodeApp App Store Profile</string>
            </dict>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
        </dict>
        </plist>
        EOF
        
    - name: Configure iOS signing
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      run: |
        echo "üîê Setting up iOS code signing with manual certificates..."
        
        # Create private_keys directory for App Store Connect API
        mkdir -p ~/private_keys
        echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/private_keys/AuthKey_$APP_STORE_CONNECT_KEY_ID.p8
        
        # Setup keychain for certificates
        echo "üîë Setting up keychain..."
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Import Distribution certificate
        if [ -n "$IOS_CERTIFICATE_P12" ] && [ -n "$IOS_CERTIFICATE_PASSWORD" ]; then
          echo "üìã Importing Distribution certificate..."
          echo "$IOS_CERTIFICATE_P12" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/xcodebuild
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          
          # List imported certificates for verification
          echo "‚úÖ Certificates imported:"
          security find-identity -v -p codesigning build.keychain
        else
          echo "‚ùå No certificate provided!"
          exit 1
        fi
        
        # Install provisioning profile
        if [ -n "$IOS_PROVISIONING_PROFILE" ]; then
          echo "üì± Installing provisioning profile..."
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          
          # Get the UUID of the provisioning profile
          PROFILE_UUID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision | plutil -extract UUID xml1 - -o - | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
          echo "üìã Provisioning Profile UUID: $PROFILE_UUID"
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          
          # Get the certificate name from the provisioning profile
          CERT_NAME=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision | grep -A 1 "DeveloperCertificates" | tail -1 | base64 --decode | openssl x509 -noout -subject | sed 's/.*CN=\([^,]*\).*/\1/')
          echo "üìã Certificate Name: $CERT_NAME"
          echo "CERT_NAME=$CERT_NAME" >> $GITHUB_ENV
          
          echo "‚úÖ Provisioning profile installed"
        else
          echo "‚ùå No provisioning profile provided!"
          exit 1
        fi
        
        echo "üîç Code signing setup complete"

    - name: Build iOS app
      run: |
        cd flutter_project
        echo "üî® Building Flutter iOS app with manual signing..."
        
        # Configure iOS project for manual signing
        echo "üîß Configuring iOS project for manual code signing..."
        
        # Set manual signing and team ID
        sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' 's/DEVELOPMENT_TEAM = "";/DEVELOPMENT_TEAM = "${{ secrets.APPLE_TEAM_ID }}";/g' ios/Runner.xcodeproj/project.pbxproj
        
        # Set provisioning profile UUID
        if [ -n "$PROFILE_UUID" ]; then
          sed -i '' "s/PROVISIONING_PROFILE_SPECIFIER = \".*\";/PROVISIONING_PROFILE_SPECIFIER = \"$PROFILE_UUID\";/g" ios/Runner.xcodeproj/project.pbxproj
          sed -i '' "s/PROVISIONING_PROFILE = \".*\";/PROVISIONING_PROFILE = \"$PROFILE_UUID\";/g" ios/Runner.xcodeproj/project.pbxproj
        fi
        
        # Set code signing identity to the imported certificate
        if [ -n "$CERT_NAME" ]; then
          sed -i '' "s/CODE_SIGN_IDENTITY = \".*\";/CODE_SIGN_IDENTITY = \"$CERT_NAME\";/g" ios/Runner.xcodeproj/project.pbxproj
          sed -i '' "s/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \".*\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"$CERT_NAME\";/g" ios/Runner.xcodeproj/project.pbxproj
        fi
        
        # Also configure Pods targets for manual signing
        if [ -f "ios/Pods/Pods.xcodeproj/project.pbxproj" ]; then
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Pods/Pods.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = "";/DEVELOPMENT_TEAM = "${{ secrets.APPLE_TEAM_ID }}";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
        fi
        
        echo "üì± Project configured for manual signing"
        
        # Get dependencies
        flutter pub get
        
        # Build iOS with manual signing
        flutter build ios --release --no-codesign
        
        # Create archive with manual signing
        echo "üèóÔ∏è Creating iOS archive..."
        xcodebuild -workspace ios/Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/ios/Runner.xcarchive \
          DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
          CODE_SIGN_STYLE=Manual \
          PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" \
          CODE_SIGN_IDENTITY="$CERT_NAME" \
          archive
          
        # Export IPA
        echo "üì¶ Exporting IPA..."
        xcodebuild -exportArchive \
          -archivePath build/ios/Runner.xcarchive \
          -exportPath build/ios/ipa \
          -exportOptionsPlist ios/exportOptions.plist
          
    - name: Upload to TestFlight
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        cd flutter_project
        echo "üì§ Uploading to TestFlight..."
        
        # Find the IPA file
        IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -n 1)
        echo "üì± IPA Path: $IPA_PATH"
        
        # Upload using altool
        xcrun altool --upload-app \
          --type ios \
          --file "$IPA_PATH" \
          --apiKey $APP_STORE_CONNECT_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \
          --show-progress
          
    - name: Notify completion
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ TestFlight deployment completed successfully!"
          echo "üì± App: $APP_NAME"
          echo "üì¶ Bundle ID: $BUNDLE_ID"
          echo "üî¢ Version: $VERSION ($BUILD_NUMBER)"
        else
          echo "‚ùå TestFlight deployment failed!"
        fi 