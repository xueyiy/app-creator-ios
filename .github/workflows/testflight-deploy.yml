name: Deploy to TestFlight

on:
  workflow_dispatch:
    inputs:
      project_data:
        description: 'Project data JSON (from your app)'
        required: false
        type: string
        default: '{}'
      app_name:
        description: 'App name for the build'
        required: true
        type: string
        default: 'NoCodeApp'
      bundle_id:
        description: 'Bundle ID (used if project_data not provided)'
        required: false
        type: string
        default: 'com.visios.nocode'
      version:
        description: 'App Version (used if project_data not provided)'
        required: false
        type: string
        default: '1.0.0'
      build_number:
        description: 'Build Number (used if project_data not provided)'
        required: false
        type: string
        default: '1'
      backend_url:
        description: 'Backend URL for app generation (or use BACKEND_URL secret)'
        required: false
        type: string
        default: ''

jobs:
  deploy-testflight:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Create Flutter project structure
      run: |
        echo "üèóÔ∏è Creating Flutter project structure..."
        
        # Parse project data to extract app info
        echo "üìä Parsing project configuration..."
        PROJECT_DATA='${{ github.event.inputs.project_data }}'
        APP_NAME='${{ github.event.inputs.app_name }}'
        
        # Check if we have meaningful project_data (not just empty {})
        if [ "$PROJECT_DATA" != "{}" ] && [ "$PROJECT_DATA" != "" ]; then
          echo "üì± Using project_data for app configuration"
          # Extract deployment info from project data
          BUNDLE_ID=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.bundleId // "${{ github.event.inputs.bundle_id }}"')
          VERSION=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.version // "${{ github.event.inputs.version }}"')
          BUILD_NUMBER=$(echo "$PROJECT_DATA" | jq -r '.deploymentInfo.buildNumber // "'$(date +%s)'"')
          USE_PROJECT_DATA=true
        else
          echo "üì± Using manual inputs for app configuration"
          # Use manual inputs
          BUNDLE_ID='${{ github.event.inputs.bundle_id }}'
          VERSION='${{ github.event.inputs.version }}'
          BUILD_NUMBER='${{ github.event.inputs.build_number }}'
          USE_PROJECT_DATA=false
          # Create minimal project data for backend call
          PROJECT_DATA='{"templateId":"default","projectId":"github-action-build","template":{},"deploymentInfo":{"appName":"'$APP_NAME'","bundleId":"'$BUNDLE_ID'","version":"'$VERSION'","buildNumber":"'$BUILD_NUMBER'"}}'
        fi
        
        echo "üì± Final App Configuration:"
        echo "   Name: $APP_NAME"
        echo "   Bundle ID: $BUNDLE_ID"
        echo "   Version: $VERSION"
        echo "   Build Number: $BUILD_NUMBER"
        echo "   Using Project Data: $USE_PROJECT_DATA"
        
        # Store in environment for later steps
        echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
        echo "PROJECT_DATA=$PROJECT_DATA" >> $GITHUB_ENV
        
        mkdir -p flutter_project
        cd flutter_project
        
        # Initialize Flutter project
        flutter create . --org=$BUNDLE_ID --project-name=app
        
        # Create the app using our backend service
        echo "üì± Generating app from backend..."
        
        # Use BACKEND_URL secret if available, otherwise use input
        BACKEND_URL='${{ secrets.BACKEND_URL }}'
        if [ -z "$BACKEND_URL" ]; then
          BACKEND_URL='${{ github.event.inputs.backend_url }}'
        fi
        
        if [ -z "$BACKEND_URL" ]; then
          echo "‚ùå No backend URL provided! Please set BACKEND_URL secret or provide backend_url input"
          exit 1
        fi
        
        echo "üåê Using backend URL: $BACKEND_URL"
        curl -X POST "$BACKEND_URL/api/package-flutter" \
          -H "Content-Type: application/json" \
          -d "$PROJECT_DATA" \
          --output app_package.zip
          
        # Extract the generated app
        echo "üì¶ Extracting generated Flutter app..."
        unzip -o app_package.zip
        
        # Create exportOptions.plist for later use
        echo "üìù Creating exportOptions.plist..."
        cat > ios/exportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>automatic</string>
        </dict>
        </plist>
        EOF
        
    - name: Configure iOS signing
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      run: |
        echo "üîê Setting up iOS code signing with manual certificates..."
        
        # Create private_keys directory for App Store Connect API
        mkdir -p ~/private_keys
        echo "$APP_STORE_CONNECT_PRIVATE_KEY" > ~/private_keys/AuthKey_$APP_STORE_CONNECT_KEY_ID.p8
        
        # Set up manual signing with certificates (more reliable than automatic)
        if [ -n "$IOS_CERTIFICATE_P12" ] && [ -n "$IOS_CERTIFICATE_PASSWORD" ]; then
          echo "üìã Setting up manual signing certificates..."
          
          # Setup keychain
          security create-keychain -p "build-keychain-password" build.keychain
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "build-keychain-password" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate
          echo "$IOS_CERTIFICATE_P12" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/xcodebuild
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "build-keychain-password" build.keychain
          
          # Install provisioning profile
          if [ -n "$IOS_PROVISIONING_PROFILE" ]; then
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
            
            # Get the provisioning profile UUID for manual signing
            PROFILE_UUID=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision | plutil -extract UUID xml1 -o - - | xmllint --xpath "//string/text()" -)
            echo "üì± Provisioning Profile UUID: $PROFILE_UUID"
            echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          fi
          
          # Get certificate common name for code signing identity
          CERT_NAME=$(security find-identity -v -p codesigning build.keychain | head -n 1 | grep -o '"[^"]*"' | sed 's/"//g')
          echo "üîë Certificate Identity: $CERT_NAME"
          echo "CERT_NAME=$CERT_NAME" >> $GITHUB_ENV
          
          echo "‚úÖ Manual signing certificates configured successfully"
        else
          echo "‚ùå No manual signing certificates provided!"
          exit 1
        fi
        
        # Verify setup
        echo "üîç Verifying signing setup..."
        echo "   Team ID: $APPLE_TEAM_ID"
        echo "   Bundle ID: com.visios.nocode"
        echo "   Certificate: $CERT_NAME"
        echo "   Profile UUID: $PROFILE_UUID"
        
    - name: Build iOS app
      run: |
        cd flutter_project
        echo "üî® Building Flutter iOS app with manual signing..."
        
        # Configure iOS project for manual signing (ONLY for main target)
        echo "üîß Configuring iOS project for manual code signing..."
        
        # Debug: Show current signing settings
        echo "üîç Current signing settings in Runner.xcodeproj:"
        grep -A 5 -B 5 "CODE_SIGN_STYLE" ios/Runner.xcodeproj/project.pbxproj || echo "No CODE_SIGN_STYLE found"
        
        # Set ONLY the main Runner target to manual signing with specific certificate and profile
        # DO NOT modify CocoaPods targets - they should use automatic signing
        sed -i '' '/PRODUCT_NAME = Runner/,/};/ s/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' '/PRODUCT_NAME = Runner/,/};/ s/DEVELOPMENT_TEAM = "";/DEVELOPMENT_TEAM = "${{ secrets.APPLE_TEAM_ID }}";/' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' '/PRODUCT_NAME = Runner/,/};/ s/PROVISIONING_PROFILE_SPECIFIER = "";/PROVISIONING_PROFILE_SPECIFIER = "'$PROFILE_UUID'";/' ios/Runner.xcodeproj/project.pbxproj
        
        # Debug: Show Runner target signing settings after modification
        echo "üîç Runner target signing settings after modification:"
        sed -n '/PRODUCT_NAME = Runner/,/};/p' ios/Runner.xcodeproj/project.pbxproj | grep -E "(CODE_SIGN_STYLE|DEVELOPMENT_TEAM|PROVISIONING_PROFILE_SPECIFIER)" || echo "No signing settings found in Runner target"
        
        # Robust Runner signing configuration using ed
        TEAM_ID="${{ secrets.APPLE_TEAM_ID }}"
        PROFILE_UUID="$PROFILE_UUID"
        PBXPROJ="ios/Runner.xcodeproj/project.pbxproj"

        echo "üîß Configuring Runner target signing with ed..."

        # Debug: Show current Runner block before modification
        echo "üîç Current Runner block before modification:"
        awk '/\/\* Runner \*\//,/\};/' "$PBXPROJ" || echo "No Runner block found"

        # Remove old lines (optional)
        echo "üßπ Removing old signing lines..."
        sed -i '' '/\/\* Runner \*\//,/};/ { /CODE_SIGN_STYLE = /d; /DEVELOPMENT_TEAM = /d; /PROVISIONING_PROFILE_SPECIFIER = /d; }' "$PBXPROJ"

        # Debug: Show Runner block after removing old lines
        echo "üîç Runner block after removing old lines:"
        awk '/\/\* Runner \*\//,/\};/' "$PBXPROJ" || echo "No Runner block found"

        # Add the signing lines using awk for robust Xcode project handling
        echo "üîß Adding signing lines with awk..."
        awk -v team_id="$TEAM_ID" -v profile="$PROFILE_UUID" '
        BEGIN{inside=0}
        {
          if ($0 ~ /^		97C146ED1CF9000F007C117D \/\* Runner \*\/ = \{$/) {inside=1}
          if (inside && $0 ~ /CODE_SIGN_STYLE = /) {next}
          if (inside && $0 ~ /DEVELOPMENT_TEAM = /) {next}
          if (inside && $0 ~ /PROVISIONING_PROFILE_SPECIFIER = /) {next}
          print $0
          if (inside && $0 ~ /^\t\t\};$/ && inside) {
            print "			CODE_SIGN_STYLE = Manual;"
            print "			DEVELOPMENT_TEAM = \"" team_id "\";"
            print "			PROVISIONING_PROFILE_SPECIFIER = \"" profile "\";"
            inside=0
          }
        }' "$PBXPROJ" > tmp && mv tmp "$PBXPROJ"

        # Debug: Show final Runner block
        echo "üîç Final Runner block after ed modification:"
        awk '/\/\* Runner \*\//,/\};/' "$PBXPROJ" || echo "No Runner block found"

        # Debug: Show specific signing settings
        echo "üîç Final Runner target signing settings:"
        awk '/\/\* Runner \*\//,/\};/' $PBXPROJ | grep -E "(CODE_SIGN_STYLE|DEVELOPMENT_TEAM|PROVISIONING_PROFILE_SPECIFIER|PRODUCT_NAME = Runner)" || echo "No signing settings found in Runner target"
        
        # Ensure CocoaPods targets use automatic signing (DO NOT specify provisioning profiles)
        if [ -f "ios/Pods/Pods.xcodeproj/project.pbxproj" ]; then
          echo "üîß Ensuring CocoaPods targets use automatic signing..."
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' ios/Pods/Pods.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = "";/DEVELOPMENT_TEAM = "${{ secrets.APPLE_TEAM_ID }}";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
          # Remove any provisioning profile specifiers from Pods targets
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*";/PROVISIONING_PROFILE_SPECIFIER = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
        fi
        
        # Fix Pods/Pods-Runner targets for automatic signing (clear out any code signing that may be left)
        PBXPROJ="ios/Pods/Pods.xcodeproj/project.pbxproj"
        if [ -f "$PBXPROJ" ]; then
          echo "üîß Cleaning up code signing from Pods targets"
          
          # Debug: Show Pods signing settings before cleanup
          echo "üîç Pods signing settings before cleanup:"
          grep -E "(CODE_SIGN_STYLE|DEVELOPMENT_TEAM|PROVISIONING_PROFILE_SPECIFIER|CODE_SIGN_IDENTITY)" $PBXPROJ || echo "No signing settings found in Pods"
          
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' $PBXPROJ
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = ".*";/PROVISIONING_PROFILE_SPECIFIER = "";/g' $PBXPROJ
          sed -i '' '/DEVELOPMENT_TEAM = .*/d' $PBXPROJ  # Remove DEVELOPMENT_TEAM lines from Pods
          sed -i '' '/CODE_SIGN_IDENTITY = .*/d' $PBXPROJ  # Remove CODE_SIGN_IDENTITY lines from Pods
          
          # Debug: Show Pods signing settings after cleanup
          echo "üîç Pods signing settings after cleanup:"
          grep -E "(CODE_SIGN_STYLE|DEVELOPMENT_TEAM|PROVISIONING_PROFILE_SPECIFIER|CODE_SIGN_IDENTITY)" $PBXPROJ || echo "No signing settings found in Pods"
        fi
        
        # Get dependencies
        flutter pub get
        
        # Build iOS with no code signing first
        flutter build ios --release --no-codesign
        
        # Create archive with manual signing ONLY for Runner target
        echo "üì¶ Creating archive with manual signing for Runner target only..."
        xcodebuild -workspace ios/Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/ios/Runner.xcarchive \
          archive
          
        # Export IPA
        echo "üì§ Exporting IPA..."
        xcodebuild -exportArchive \
          -archivePath build/ios/Runner.xcarchive \
          -exportPath build/ios/ipa \
          -exportOptionsPlist ios/exportOptions.plist
          
    - name: Upload to TestFlight
      env:
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        cd flutter_project
        echo "üì§ Uploading to TestFlight..."
        
        # Find the IPA file
        IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -n 1)
        echo "üì± IPA Path: $IPA_PATH"
        
        # Upload using altool
        xcrun altool --upload-app \
          --type ios \
          --file "$IPA_PATH" \
          --apiKey $APP_STORE_CONNECT_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID \
          --show-progress
          
    - name: Notify completion
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ TestFlight deployment completed successfully!"
          echo "üì± App: $APP_NAME"
          echo "üì¶ Bundle ID: $BUNDLE_ID"
          echo "üî¢ Version: $VERSION ($BUILD_NUMBER)"
        else
          echo "‚ùå TestFlight deployment failed!"
        fi 